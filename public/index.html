<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirXchange</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --airxchange-bg: #f0f4f8;
            --airxchange-text: #333;
            --airxchange-primary: #1e90ff;
            --airxchange-primary-dark: #1c6ea4;
            --airxchange-border: #1e90ff;
            --airxchange-card-bg: #fff;
            --airxchange-shadow: rgba(0,0,0,0.15);
            --airxchange-success: #28a745;
            --airxchange-error: #dc3545;
            --airxchange-accent: #ff6f61;
        }
        
        .airxchange-container { 
            max-width: 900px; margin: 20px auto; padding: 20px; 
            background: #cee5fc; border-radius: 15px; 
            box-shadow: 0 4px 12px var(--airxchange-shadow); 
            animation: airxchange-fadeIn 0.5s ease-in; 
            position: relative;
        }
        .airxchange-tabs { 
            display: flex; margin-bottom: 20px; gap: 10px; 
            justify-content: center; 
        }
        .airxchange-tab { 
            flex: 1; padding: 12px; text-align: center; 
            background: var(--airxchange-primary); color: white; 
            border-radius: 8px; cursor: pointer; transition: all 0.3s ease; 
        }
        .airxchange-tab:hover { background: var(--airxchange-primary-dark); transform: scale(1.05); }
        .airxchange-tab.active { background: var(--airxchange-primary-dark); transform: scale(1.02); }
        .airxchange-tab-content { display: none; }
        .airxchange-tab-content.active { display: block; animation: airxchange-slideIn 0.3s ease; }
        .airxchange-text-editor { 
            width: 100%; min-height: 250px; padding: 15px; 
            border: 2px solid var(--airxchange-border); border-radius: 10px; 
            resize: none; font-size: 16px; margin-bottom: 15px; 
            background-color: var(--airxchange-card-bg); 
            transition: border-color 0.3s ease, opacity 0.5s ease; 
            position: relative; 
        }
        .airxchange-text-editor:focus { border-color: var(--airxchange-primary-dark); outline: none; }
        .airxchange-text-editor.fade-out { opacity: 0; }
        .airxchange-cursor { 
            position: absolute; height: 2px; background: var(--airxchange-primary); 
            width: 2px; transform: translateY(-50%); transition: all 0.1s ease; 
        }
        .airxchange-file-upload-section { 
            border: 2px dashed var(--airxchange-border); padding: 30px; 
            text-align: center; border-radius: 10px; margin-top: 20px; 
            background: rgba(30, 144, 255, 0.05); transition: all 0.3s ease; 
        }
        .airxchange-file-upload-section.dragover { background: rgba(30, 144, 255, 0.15); transform: scale(1.02); }
        .airxchange-file-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 15px; padding: 0; margin-bottom: 20px; 
        }
        .airxchange-file-card { 
            padding: 10px; background: var(--airxchange-card-bg); 
            border-radius: 10px; box-shadow: 0 3px 8px var(--airxchange-shadow); 
            text-align: center; transition: transform 0.2s ease; 
            cursor: pointer; 
        }
        .airxchange-file-card:hover { transform: translateY(-5px); }
        .airxchange-file-preview { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin: 0 auto 10px; }
        .airxchange-file-icon { font-size: 24px; margin: 10px auto; color: white; }
        .airxchange-file-info { font-size: 14px; overflow: hidden; }
        .airxchange-file-link { 
            color: var(--airxchange-primary); text-decoration: none; 
            display: block; overflow: hidden; text-overflow: ellipsis; 
            white-space: nowrap; 
        }
        .airxchange-btn { 
            padding: 8px 15px; border: none; border-radius: 6px; 
            cursor: pointer; background: var(--airxchange-primary); 
            color: white; margin: 5px 5px; transition: all 0.3s ease; 
            font-size: 14px; min-width: 90px; 
        }
        .airxchange-btn:hover { background: var(--airxchange-primary-dark); transform: scale(1.05); }
        .airxchange-file-actions { display: flex; gap: 10px; justify-content: flex-start; margin-bottom: 15px; }
        .airxchange-file-actions .airxchange-btn { background: #dc3545; }
        .airxchange-file-actions .airxchange-btn.airxchange-download-all { background: var(--airxchange-success); }
        .airxchange-add-file-card { 
            padding: 10px; background: var(--airxchange-card-bg); 
            border-radius: 10px; box-shadow: 0 3px 8px var(--airxchange-shadow); 
            text-align: center; transition: transform 0.2s ease; 
            cursor: pointer; 
        }
        .airxchange-add-file-card:hover { transform: translateY(-5px); }
        .airxchange-add-file-icon { font-size: 24px; margin: 10px auto; color: white; }
        .airxchange-add-file-text { font-size: 14px; color: var(--airxchange-primary); }
        .airxchange-file-actions-icons { display: flex; gap: 8px; justify-content: center; margin-top: 10px; }
        .airxchange-file-action-btn { cursor: pointer; padding: 5px; font-size: 18px; transition: opacity 0.2s; color: white; }
        .airxchange-file-action-btn:hover { opacity: 0.7; }
        .airxchange-progress-container { margin-top: 10px; }
        .airxchange-progress-bar { 
            width: 100%; height: 10px; background: #ddd; border-radius: 5px; 
            overflow: hidden; display: none; 
        }
        .airxchange-progress-fill { 
            height: 100%; background: var(--airxchange-primary); 
            width: 0; transition: width 0.3s ease; 
        }
        .airxchange-progress-text { font-size: 14px; text-align: center; margin: 5px 0; }
        .airxchange-success-tick { 
            font-size: 24px; color: var(--airxchange-success); 
            display: none; animation: airxchange-bounceIn 0.5s ease; 
            margin: 5px auto; 
        }
        .airxchange-expiry-section { 
            text-align: center; margin-bottom: 20px; 
            display: flex; justify-content: center; gap: 15px; align-items: center; 
            flex-wrap: wrap; 
        }
        .airxchange-expiry-wrapper { display: flex; align-items: center; gap: 10px; }
        .airxchange-expiry-select { 
            padding: 10px 30px 10px 15px; font-size: 14px; 
            border: 2px solid var(--airxchange-border); border-radius: 25px; 
            background: var(--airxchange-card-bg); cursor: pointer; 
            appearance: none; transition: all 0.3s ease; 
            box-shadow: 0 2px 5px var(--airxchange-shadow); 
        }
        .airxchange-expiry-select:hover { border-color: var(--airxchange-primary-dark); }
        .airxchange-expiry-select:focus { outline: none; border-color: var(--airxchange-accent); }
        .airxchange-expiry-wrapper::after { 
            content: "â–¼"; position: absolute; right: 10px; top: 50%; 
            transform: translateY(-50%); pointer-events: none; 
            color: var(--airxchange-primary); 
        }
        .airxchange-expiry-custom-input { 
            padding: 8px; font-size: 14px; border: 2px solid var(--airxchange-border); 
            border-radius: 5px; width: 100px; display: none; 
        }
        .airxchange-expiry-reset-btn { 
            background: var(--airxchange-accent); padding: 8px 15px; 
            border-radius: 20px; border: none; cursor: pointer; 
            transition: all 0.3s ease; font-size: 14px; 
            box-shadow: 0 2px 5px var(--airxchange-shadow); 
        }
        .airxchange-expiry-reset-btn:hover { background: #e65b4d; transform: scale(1.05); }
        .airxchange-modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.5); z-index: 1000; 
            justify-content: center; align-items: center; 
        }
        .airxchange-modal-content { 
            background: var(--airxchange-card-bg); padding: 20px; border-radius: 10px; 
            box-shadow: 0 4px 12px var(--airxchange-shadow); max-width: 80%; max-height: 80%; 
            overflow: auto; position: relative; 
        }
        .airxclose { 
            position: absolute; top: 10px; right: 10px; font-size: 24px; 
            cursor: pointer; color: white; 
            transition: color 0.3s ease; 
        }
        .airxclose:hover { color: var(--airxchange-primary); }
        .airxchange-notification { 
            position: fixed; bottom: 20px; right: 20px; 
            padding: 10px 20px; border-radius: 5px; 
            box-shadow: 0 2px 5px var(--airxchange-shadow); 
            animation: airxchange-notification 3s ease-out; display: none; z-index: 1001; 
        }
        .airxchange-notification.add { background: var(--airxchange-success); color: white; }
        .airxchange-notification.remove { background: var(--airxchange-error); color: white; }
        #airxchange-userCountDisplay {
            transition: all 0.3s ease;
        }
        .airxchange-user-update-animation {
            animation: userUpdate 0.5s ease-in-out;
        }
        #airxchange-userIconPermanent {
            display: inline-block;
            animation: iconChange 0.5s ease-in-out;
        }
        .airxchange-saved-texts { 
            margin-top: 15px; padding: 10px; background: var(--airxchange-card-bg); 
            border-radius: 8px; box-shadow: 0 2px 6px var(--airxchange-shadow); 
            display: none; 
            animation: airxchange-slideIn 0.3s ease; 
        }
        .airxchange-saved-texts h3 { 
            margin-bottom: 10px; color: var(--airxchange-primary); font-size: 16px; 
            font-weight: bold; 
        }
        .airxchange-saved-text { 
            padding: 6px; border: 1px solid var(--airxchange-border); border-radius: 5px; 
            margin-bottom: 8px; background: rgba(30, 144, 255, 0.05); 
            position: relative; color: var(--airxchange-text); 
            width: fit-content; min-width: 100%; max-width: 100%; 
            transition: max-width 0.3s ease; 
        }
        .airxchange-saved-text-collapsed { 
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; 
            overflow: hidden; 
        }
        .airxchange-saved-text-full { 
            white-space: pre-wrap; word-wrap: break-word; 
            max-width: none; 
        }
        .airxchange-saved-text .read-more { 
            color: var(--airxchange-primary); cursor: pointer; font-size: 12px; 
            margin-top: 5px; display: none; /* Hidden by default, will be replaced by clickable dots */
        }
        .airxchange-saved-text .read-more:hover { text-decoration: underline; }
        .airxchange-saved-text .dots { 
            color: var(--airxchange-primary); cursor: pointer; font-size: 12px; 
            margin-top: 5px; display: block; 
        }
        .airxchange-saved-text .dots:hover { text-decoration: underline; }
        .airxchange-saved-text-actions { 
            position: absolute; top: 6px; right: 10px; display: flex; gap: 5px; 
            z-index: 1; 
        }
        .airxchange-saved-text-action-btn { 
            cursor: pointer; font-size: 14px; color: black; 
            transition: opacity 0.2s; 
        }
        .airxchange-saved-text-action-btn:hover { opacity: 0.7; }
        @keyframes airxchange-notification { 
            0% { opacity: 0; transform: translateY(20px); } 
            10% { opacity: 1; transform: translateY(0); } 
            90% { opacity: 1; transform: translateY(0); } 
            100% { opacity: 0; transform: translateY(20px); } 
        }
        @keyframes airxchange-fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes airxchange-slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes airxchange-bounceIn { 
            0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } 
        }
        @keyframes airxchange-fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes airxchange-pulse { 
            0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } 
        }
        @keyframes userUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes iconChange {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @media (max-width: 768px) { 
            .airxchange-container { margin: 10px; padding: 15px; } 
            .airxchange-file-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); } 
            .airxchange-expiry-section { flex-direction: column; gap: 10px; }
            .airxchange-expiry-select { width: 100%; max-width: 200px; }
            .airxchange-expiry-custom-input { width: 100%; max-width: 120px; }
            .airxchange-expiry-reset-btn { width: 100%; max-width: 120px; }
            .airxchange-modal-content { max-width: 90%; max-height: 90%; }
            .airxchange-file-actions { flex-direction: row; justify-content: flex-start; gap: 5px; }
            .airxchange-btn { padding: 6px 10px; min-width: 70px; margin: 5px 2px; font-size: 12px; }
            .airxchange-notification { bottom: 10px; right: 10px; padding: 8px 15px; font-size: 12px; }
            #airxchange-userCountDisplay { top: 5px; right: 5px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="airxchange-container">
        <div id="airxchange-userCountDisplay" style="position: absolute; top: 10px; right: 10px; font-size: 14px; display: flex; align-items: center; gap: 5px;">
            <span id="airxchange-userIconPermanent"><i class="fas fa-user" style="color: black;"></i></span>
            <span id="airxchange-userCountText">0 users collaborating</span>
            <span id="airxchange-userIcon" style="font-size: 16px;"></span>
        </div>
        <h1 style="text-align: center; margin-bottom: 10px;">AirXchange <i class="fas fa-rocket" style="color: var(--airxchange-primary); font-size: 20px;"></i></h1>
        <div class="airxchange-expiry-section">
            <label>Data expires in:</label>
            <div class="airxchange-expiry-wrapper">
                <select id="airxchange-expiry" class="airxchange-expiry-select" onchange="handleExpiryChange()">
                    <option value="1800000">30 Minutes</option>
                    <option value="3600000">1 Hour</option>
                    <option value="5400000">1.5 Hours</option>
                    <option value="7200000">2 Hours</option>
                    <option value="custom">Custom</option>
                </select>
                <input type="number" id="airxchange-customInput" class="airxchange-expiry-custom-input" 
                       placeholder="Minutes" min="1" onchange="setCustomExpiry()">
                <button class="airxchange-expiry-reset-btn" onclick="resetExpiry()"><i class="fas fa-undo" style="color: white;"></i> Reset</button>
            </div>
        </div>
        
        <div class="airxchange-tabs">
            <div class="airxchange-tab active" onclick="switchTab('text')"><i class="fas fa-file-alt" style="color: white;"></i> Text</div>
            <div class="airxchange-tab" onclick="switchTab('file')"><i class="fas fa-folder" style="color: white;"></i> Files</div>
        </div>

        <div id="airxchange-textTab" class="airxchange-tab-content active">
            <textarea class="airxchange-text-editor" placeholder="Start typing..." oninput="handleTextInput()"></textarea>
            <div style="text-align: center; display: flex; justify-content: center; flex-wrap: wrap; gap: 5px;">
                <button class="airxchange-btn" onclick="downloadText()"><i class="fas fa-download" style="color: white;"></i> Download</button>
                <button class="airxchange-btn" onclick="saveTextForExpiry()"><i class="fas fa-save" style="color: white;"></i> Save Text</button>
                <button class="airxchange-btn" onclick="copyText()"><i class="far fa-copy" style="color: white;"></i> Copy</button>
                <button class="airxchange-btn" onclick="clearText()"><i class="fas fa-trash" style="color: white;"></i> Clear</button>
            </div>
            <div id="airxchange-saved-texts" class="airxchange-saved-texts">
                <h3>Saved Texts</h3>
                <div id="airxchange-saved-texts-list"></div>
            </div>
        </div>

        <div id="airxchange-fileTab" class="airxchange-tab-content">
            <div class="airxchange-file-actions">
                <button class="airxchange-btn airxchange-download-all" onclick="downloadAllFiles()">
                    <i class="fas fa-download" style="color: white;"></i> Download All
                </button>
                <button class="airxchange-btn" onclick="deleteAllFiles()">
                    <i class="fas fa-trash" style="color: white;"></i> Delete All
                </button>
            </div>
            <div class="airxchange-file-grid" id="airxchange-fileGrid"></div>
            <div class="airxchange-file-upload-section" id="airxchange-dropZone">
                <p><i class="fas fa-cloud-upload-alt" style="color: black;"></i> Drag & drop files or click to upload multiple files</p>
                <input type="file" id="airxchange-fileInput" multiple hidden>
                <button class="airxchange-btn" onclick="document.getElementById('airxchange-fileInput').click()">
                    <i class="fas fa-upload" style="color: white;"></i> Choose Files
                </button>
                <div id="airxchange-progressContainer" class="airxchange-progress-container"></div>
                <div id="airxchange-downloadProgress" class="airxchange-progress-container" style="display: none;">
                    <div class="airxchange-progress-text" id="airxchange-downloadProgressText">Downloading... 0%</div>
                    <div class="airxchange-progress-bar">
                        <div class="airxchange-progress-fill" id="airxchange-downloadProgressFill"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="airxchange-modal" id="airxchange-fileModal">
        <div class="airxchange-modal-content">
            <span class="airxclose" onclick="closeModal()"><i class="fas fa-times" style="color: red;"></i></span>
            <div id="airxchange-modalContent"></div>
        </div>
    </div>

    <div class="airxchange-notification" id="airxchange-notification"></div>

    <script src="https://air-exchange.onrender.com/socket.io/socket.io.js"></script>
    <script>
        const socket = io('https://air-exchange.onrender.com', { forceNew: true });
        const textEditor = document.querySelector('.airxchange-text-editor');
        const fileInput = document.getElementById('airxchange-fileInput');
        const fileGrid = document.getElementById('airxchange-fileGrid');
        const dropZone = document.getElementById('airxchange-dropZone');
        const progressContainer = document.getElementById('airxchange-progressContainer');
        const downloadProgress = document.getElementById('airxchange-downloadProgress');
        const downloadProgressText = document.getElementById('airxchange-downloadProgressText');
        const downloadProgressFill = document.getElementById('airxchange-downloadProgressFill');
        const expirySelect = document.getElementById('airxchange-expiry');
        const customInput = document.getElementById('airxchange-customInput');
        const resetBtn = document.querySelector('.airxchange-expiry-reset-btn');
        const fileModal = document.getElementById('airxchange-fileModal');
        const modalContent = document.getElementById('airxchange-modalContent');
        const notification = document.getElementById('airxchange-notification');
        const savedTextsContainer = document.getElementById('airxchange-saved-texts');
        const savedTextsList = document.getElementById('airxchange-saved-texts-list');
        let files = [];
        let roomId = null;
        let expiryTime = 1800000;
        let cursors = new Map();
        let currentUserCount = 0;
        let savedTexts = [];

        // WebRTC setup
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        const peerConnection = new RTCPeerConnection(rtcConfig);

        socket.on('connect', () => {
            console.log('Socket connected:', socket.id);
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    const candidate = event.candidate.candidate;
                    const localIpMatch = candidate.match(/(\d+\.\d+\.\d+\.\d+)/);
                    if (localIpMatch) {
                        const localIp = localIpMatch[1];
                        roomId = localIp.split('.').slice(0, 3).join('.');
                        socket.emit('joinRoom', { roomId, clientId: socket.id });
                        console.log(`Joined room based on local IP: ${roomId}`);
                    }
                }
            };

            peerConnection.createDataChannel('discovery');
            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .catch(err => console.error('WebRTC error:', err));
        });

        socket.on('init', (data) => {
            textEditor.value = data.text;
            files = data.files;
            expiryTime = data.expiry || 1800000;
            savedTexts = data.savedTexts || [];
            updateExpiryUI();
            updateFileGrid();
            updateAddNewCard();
            updateSavedTexts();
        });

        socket.on('textUpdate', (text) => {
            textEditor.value = text;
            textEditor.classList.remove('fade-out');
            updateCursors();
        });

        socket.on('newFile', (file) => {
            files.push(file);
            updateFileGrid();
            showNotification(`New file uploaded: ${file.originalname}`, 'add');
            updateAddNewCard();
        });

        socket.on('fileDeleted', (filename) => {
            files = files.filter(file => file.filename !== filename);
            updateFileGrid();
            showNotification(`File deleted: ${filename}`, 'remove');
            updateAddNewCard();
        });

        socket.on('allFilesDeleted', () => {
            files = [];
            updateFileGrid();
            showNotification('All files deleted', 'remove');
            updateAddNewCard();
        });

        socket.on('clearText', () => {
            textEditor.classList.add('fade-out');
            setTimeout(() => {
                textEditor.value = '';
                textEditor.classList.remove('fade-out');
                updateCursors();
            }, 500);
        });

        socket.on('expiryUpdate', (newExpiry) => {
            expiryTime = newExpiry;
            updateExpiryUI();
        });

        socket.on('cursorUpdate', ({ id, position }) => {
            cursors.set(id, position);
            updateCursors();
        });

        socket.on('userCountUpdate', (count) => {
            const previousCount = currentUserCount;
            updateUserCount(count, count > previousCount ? 'add' : (count < previousCount ? 'remove' : null));
        });

        socket.on('savedText', (savedText) => {
            savedTexts.push(savedText);
            updateSavedTexts();
        });

        socket.on('deleteSavedText', (index) => {
            savedTexts.splice(index, 1);
            updateSavedTexts();
        });

        function handleTextInput() {
            if (!roomId) return;
            socket.emit('textUpdate', textEditor.value);
            socket.emit('cursorUpdate', getCursorPosition());
        }

        function downloadText() {
            const blob = new Blob([textEditor.value], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `airxchange-${Date.now()}.txt`;
            a.click();
        }

        function saveTextForExpiry() {
            if (!roomId || !textEditor.value.trim()) return;
            const savedText = {
                text: textEditor.value,
                timestamp: Date.now(),
                expiry: expiryTime
            };
            socket.emit('saveText', savedText);
            showNotification('Text saved!', 'add');
        }

        function clearText() {
            if (!roomId) return;
            if (confirm('Clear all text?')) {
                textEditor.classList.add('fade-out');
                setTimeout(() => {
                    textEditor.value = '';
                    textEditor.classList.remove('fade-out');
                    socket.emit('clearText');
                    cursors.clear();
                    updateCursors();
                }, 500);
            }
        }

        function copyText() {
            textEditor.select();
            document.execCommand('copy');
            alert('Text copied to clipboard!');
        }

        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'tiff', 'webp', 'svg', 'heif', 'heic', 'raw', 'psd', 'eps', 'ai', 'ico', 'avif', 'dng', 'cr2', 'nef', 'orf'];
            if (imageExtensions.includes(ext)) return '<img class="airxchange-file-preview" src="https://air-exchange.onrender.com/uploads/' + fileName + '">';
            if (['xls', 'xlsx'].includes(ext)) return '<i class="fas fa-file-excel" style="font-size: 48px;color: black; margin-bottom: 15px;"></i>';
            if (['CSV'].includes(ext)) return '<i class="fas fa-file-csv" style="font-size: 48px;color: black; margin-bottom: 15px;"></i>';
            if (['doc', 'docx'].includes(ext)) return '<i class="fas fa-file-word" style="font-size: 48px;color: black; margin-bottom: 15px;"></i>';
            if (['mp4', 'webm', 'ogg'].includes(ext)) return '<i class="fa-solid fa-video" style="font-size: 48px;color: black; margin-bottom: 15px;"></i>';
            if (['zip'].includes(ext)) return '<i class="fas fa-file-archive" style="font-size: 48px;color: black; margin-bottom: 15px;"></i>';
            if (['pdf'].includes(ext)) return '<i class="fas fa-file-pdf" style="font-size: 48px;color: black; margin-bottom: 15px;"></i>';
            return '<i class="fas fa-file" style="font-size: 48px;color: black; margin-bottom: 15px;"></i>';
        }

        function updateFileGrid() {
            fileGrid.innerHTML = '';
            files.forEach(file => {
                const preview = getFileIcon(file.filename);
                fileGrid.innerHTML += `
                    <div class="airxchange-file-card" onclick="openFileModal('${file.filename}', '${file.originalname}')">
                        ${preview}
                        <div class="airxchange-file-info">
                            <a href="https://air-exchange.onrender.com/uploads/${file.filename}" 
                               class="airxchange-file-link" 
                               download="${file.originalname}">
                                ${file.originalname}
                            </a>
                            <small>${new Date(file.timestamp).toLocaleTimeString()}</small>
                        </div>
                        <div class="airxchange-file-actions-icons">
                            <a href="https://air-exchange.onrender.com/download/${file.filename}" download 
                               class="airxchange-file-action-btn" title="Download">
                                <i class="fas fa-download" style="color: black;"></i>
                            </a>
                            <span class="airxchange-file-action-btn" title="Delete" 
                                  onclick="deleteSingleFile('${file.filename}'); event.stopPropagation();">
                                <i class="fas fa-trash" style="color: black;"></i>
                            </span>
                        </div>
                    </div>
                `;
            });
            updateAddNewCard();
        }

        function updateAddNewCard() {
            const existingAddCard = fileGrid.querySelector('.airxchange-add-file-card');
            if (existingAddCard) {
                existingAddCard.remove();
            }
            if (files.length > 0) {
                const addNewCard = `
                    <div class="airxchange-add-file-card" onclick="document.getElementById('airxchange-fileInput').click()">
                        <div class="airxchange-add-file-icon"><i class="fas fa-plus" style="color: green;"></i></div>
                        <div class="airxchange-add-file-text">Add New</div>
                    </div>
                `;
                fileGrid.innerHTML += addNewCard;
            }
        }

        function handleFileUpload(fileList) {
            if (!roomId) return;
            if (!fileList || fileList.length === 0) return;

            progressContainer.innerHTML = '';
            Array.from(fileList).forEach(file => {
                const fileId = `${file.name}-${Date.now()}`;
                const progressDiv = document.createElement('div');
                progressDiv.innerHTML = `
                    <div class="airxchange-progress-text" id="progressText-${fileId}">${file.name} - Uploading... 0%</div>
                    <div class="airxchange-progress-bar">
                        <div class="airxchange-progress-fill" id="progressFill-${fileId}"></div>
                    </div>
                    <div class="airxchange-success-tick" id="successTick-${fileId}"><i class="fas fa-check" style="color: white;"></i></div>
                `;
                progressContainer.appendChild(progressDiv);

                const progressText = document.getElementById(`progressText-${fileId}`);
                const progressFill = document.getElementById(`progressFill-${fileId}`);
                const successTick = document.getElementById(`successTick-${fileId}`);

                const formData = new FormData();
                formData.append('file', file);
                const fileSizeMB = file.size / (1024 * 1024);

                if (fileSizeMB > 5) {
                    progressText.textContent += ' (Larger files may take some time, please be patient ðŸ˜Š)';
                }

                const xhr = new XMLHttpRequest();
                xhr.open('POST', 'https://air-exchange.onrender.com/upload', true);
                xhr.setRequestHeader('X-Room-Id', roomId);

                xhr.upload.onprogress = (event) => {
                    if (event.lengthComputable) {
                        const percent = Math.round((event.loaded / event.total) * 100);
                        progressFill.style.width = `${percent}%`;
                        progressText.textContent = `${file.name} - Uploading... ${percent}%${fileSizeMB > 5 ? ' (Please be patient ðŸ˜Š)' : ''}`;
                    }
                };

                xhr.onload = () => {
                    if (xhr.status === 200) {
                        const data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            progressText.textContent = `${file.name} - Uploaded!`;
                            successTick.style.display = 'block';
                            setTimeout(() => {
                                progressDiv.remove();
                            }, 2000);
                        } else {
                            throw new Error(data.error);
                        }
                    } else {
                        throw new Error('Upload failed');
                    }
                };

                xhr.onerror = () => {
                    alert(`Upload failed for ${file.name} due to a network error.`);
                    progressDiv.remove();
                };

                xhr.send(formData);
            });
        }

        async function deleteAllFiles() {
            if (!roomId) return;
            if (!confirm('Delete ALL files permanently?')) return;
            
            try {
                const response = await fetch('https://air-exchange.onrender.com/delete-all', {
                    method: 'DELETE',
                    headers: { 'X-Room-Id': roomId }
                });
                const data = await response.json();
                if (data.success) {
                    files = [];
                    updateFileGrid();
                } else {
                    throw new Error(data.error);
                }
            } catch (err) {
                alert('Failed to delete files: ' + err.message);
            }
        }

        async function downloadAllFiles() {
            if (!roomId || files.length === 0) return alert('No files to download!');
            
            downloadProgress.style.display = 'block';
            downloadProgressText.textContent = 'Downloading... 0%';
            downloadProgressFill.style.width = '0%';

            const zip = new JSZip();
            const folder = zip.folder("AirXchange_Files");
            
            let progress = 0;
            let totalFiles = files.length;
            let completedFiles = 0;

            const processFile = (file, index) => {
                fetch(file.url)
                    .then(response => response.blob())
                    .then(blob => {
                        folder.file(file.originalname, blob);
                        completedFiles++;
                        progress = Math.round((completedFiles / totalFiles) * 100);
                        downloadProgressText.textContent = `Downloading... ${progress}%`;
                        downloadProgressFill.style.width = `${progress}%`;
                        if (completedFiles === totalFiles) {
                            zip.generateAsync({ type: "blob" }).then(content => {
                                const url = URL.createObjectURL(content);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `AirXchange_Files_${Date.now()}.zip`;
                                a.click();
                                downloadProgress.style.display = 'none';
                            }).catch(err => {
                                alert('Download failed: ' + err.message);
                                downloadProgress.style.display = 'none';
                            });
                        }
                    })
                    .catch(err => {
                        alert('Download failed for ' + file.originalname + ': ' + err.message);
                        downloadProgress.style.display = 'none';
                    });
            };

            files.forEach((file, index) => processFile(file, index));
        }

        async function deleteSingleFile(filename) {
            if (!roomId) return;
            if (!confirm('Delete this file permanently?')) return;
            
            try {
                const response = await fetch(`https://air-exchange.onrender.com/delete-file/${filename}`, {
                    method: 'DELETE',
                    headers: { 'X-Room-Id': roomId }
                });
                const data = await response.json();
                if (data.success) {
                    files = files.filter(f => f.filename !== filename);
                    updateFileGrid();
                } else {
                    throw new Error(data.error);
                }
            } catch (err) {
                alert('Failed to delete file: ' + err.message);
            }
        }

        function handleExpiryChange() {
            const value = expirySelect.value;
            if (value === 'custom') {
                customInput.style.display = 'inline-block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                expiryTime = parseInt(value);
                if (roomId) {
                    socket.emit('setExpiry', { roomId, expiryTime });
                    socket.to(roomId).emit('expiryUpdate', expiryTime);
                }
            }
            updateExpiryUI();
        }

        function setCustomExpiry() {
            const minutes = parseInt(customInput.value) || 0;
            if (minutes >= 1) {
                expiryTime = minutes * 60 * 1000;
                if (roomId) {
                    socket.emit('setExpiry', { roomId, expiryTime });
                    socket.to(roomId).emit('expiryUpdate', expiryTime);
                }
                customInput.style.display = 'none';
                customInput.value = '';
            } else {
                alert('Please enter a valid time (minimum 1 minute)');
            }
            updateExpiryUI();
        }

        function resetExpiry() {
            expiryTime = 1800000;
            expirySelect.value = '1800000';
            customInput.style.display = 'none';
            customInput.value = '';
            if (roomId) {
                socket.emit('setExpiry', { roomId, expiryTime });
                socket.to(roomId).emit('expiryUpdate', expiryTime);
            }
            updateExpiryUI();
        }

        function updateExpiryUI() {
            customInput.style.display = expirySelect.value === 'custom' ? 'inline-block' : 'none';
            if (expirySelect.value === 'custom') {
                customInput.value = Math.round(expiryTime / 60000) || '';
            } else {
                expirySelect.value = [1800000, 3600000, 5400000, 7200000].includes(expiryTime) ? expiryTime.toString() : 'custom';
            }
        }

        function getCursorPosition() {
            const start = textEditor.selectionStart;
            const rect = textEditor.getBoundingClientRect();
            const lineHeight = parseInt(window.getComputedStyle(textEditor).lineHeight) || 20;
            const line = textEditor.value.substr(0, start).split('\n').length - 1;
            const charInLine = start - textEditor.value.lastIndexOf('\n', start - 1) - 1;
            const x = charInLine * 8 + 10;
            const y = line * lineHeight + lineHeight / 2;
            return { x: x + rect.left, y: y + rect.top };
        }

        function updateCursors() {
            const cursorsDiv = textEditor.parentElement.querySelectorAll('.airxchange-cursor');
            cursorsDiv.forEach(cursor => cursor.remove());
            cursors.forEach((position, id) => {
                if (id !== socket.id) {
                    const cursor = document.createElement('div');
                    cursor.className = 'airxchange-cursor';
                    cursor.style.left = `${position.x}px`;
                    cursor.style.top = `${position.y}px`;
                    textEditor.parentElement.appendChild(cursor);
                }
            });
        }

        function updateUserCount(count, changeType = null) {
            const userCountText = document.getElementById('airxchange-userCountText');
            const userIcon = document.getElementById('airxchange-userIcon');
            const userIconPermanent = document.getElementById('airxchange-userIconPermanent');
            const display = document.getElementById('airxchange-userCountDisplay');

            const previousCount = currentUserCount;
            currentUserCount = count;
            userCountText.textContent = `${count} user${count === 1 ? '' : 's'} collaborating`;

            let newIcon;
            if (count === 1) {
                newIcon = '<i class="fas fa-user" style="color: black;"></i>';
            } else if (count === 2) {
                newIcon = '<i class="fas fa-user-friends" style="color: black;"></i>';
            } else if (count >= 3) {
                newIcon = '<i class="fas fa-users" style="color: black;"></i>';
            }
            if (newIcon && userIconPermanent.innerHTML !== newIcon) {
                userIconPermanent.innerHTML = newIcon;
                userIconPermanent.classList.add('airxchange-user-update-animation');
                setTimeout(() => {
                    userIconPermanent.classList.remove('airxchange-user-update-animation');
                }, 500);
            }

            if (changeType === 'add') {
                userIcon.innerHTML = '<i class="fas fa-user-plus" style="color: black;"></i>';
                display.classList.add('airxchange-user-update-animation');
            } else if (changeType === 'remove') {
                userIcon.innerHTML = '<i class="fas fa-user-minus" style="color: black;"></i>';
                display.classList.add('airxchange-user-update-animation');
            } else {
                userIcon.innerHTML = '';
            }

            if (changeType) {
                setTimeout(() => {
                    display.classList.remove('airxchange-user-update-animation');
                    userIcon.innerHTML = '';
                }, 500);
            }
        }

        function updateSavedTexts() {
            const now = Date.now();
            savedTexts = savedTexts.filter(text => now - text.timestamp < text.expiry);
            if (savedTexts.length > 0) {
                savedTextsContainer.style.display = 'block';
                savedTextsList.innerHTML = savedTexts.map((text, index) => {
                    const lines = text.text.split('\n');
                    const isLong = lines.join(' ').trim().split(/\s+/).length > 30;
                    const displayLines = isLong ? lines.slice(0, 3).join('\n') + 'â€¦' : text.text;
                    return `
                        <div class="airxchange-saved-text ${isLong ? 'airxchange-saved-text-collapsed' : ''}" data-full-text="${text.text}" data-index="${index}">
                            <div class="airxchange-saved-text-content">
                                ${displayLines}
                                <br><small>Saved at: ${new Date(text.timestamp).toLocaleString()}</small>
                            </div>
                            ${isLong ? '<span class="dots" onclick="toggleReadMore(this)">â€¦</span>' : ''}
                            <div class="airxchange-saved-text-actions">
                                <span class="airxchange-saved-text-action-btn" title="Copy" onclick="copySavedText(${index})">
                                    <i class="fas fa-copy" style="color: black;"></i>
                                </span>
                                <span class="airxchange-saved-text-action-btn" title="Delete" onclick="deleteSavedText(${index})">
                                    <i class="fas fa-trash" style="color: black;"></i>
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                savedTextsContainer.style.display = 'none';
            }
        }

        function toggleReadMore(element) {
            const parent = element.parentElement;
            const content = parent.querySelector('.airxchange-saved-text-content');
            if (parent.classList.contains('airxchange-saved-text-collapsed')) {
                content.innerHTML = `${parent.dataset.fullText}<br><small>Saved at: ${new Date(savedTexts[parent.dataset.index].timestamp).toLocaleString()}</small>`;
                parent.classList.remove('airxchange-saved-text-collapsed');
                parent.classList.add('airxchange-saved-text-full');
                element.textContent = 'See Less';
                parent.style.maxWidth = 'none'; // Allow full width when expanded
            } else {
                const lines = parent.dataset.fullText.split('\n');
                const shortText = lines.slice(0, 3).join('\n') + 'â€¦';
                content.innerHTML = `${shortText}<br><small>Saved at: ${new Date(savedTexts[parent.dataset.index].timestamp).toLocaleString()}</small>`;
                parent.classList.remove('airxchange-saved-text-full');
                parent.classList.add('airxchange-saved-text-collapsed');
                element.textContent = 'â€¦';
                parent.style.maxWidth = '100%'; // Reset to container width when collapsed
            }
        }

        function copySavedText(index) {
            const text = savedTexts[index].text;
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Text copied to clipboard!', 'add');
            }).catch(err => {
                alert('Failed to copy text: ' + err.message);
            });
        }

        function deleteSavedText(index) {
            if (!confirm('Delete this saved text permanently?')) return;
            socket.emit('deleteSavedText', index);
            showNotification('Text deleted!', 'remove');
        }

        textEditor.addEventListener('mousemove', () => {
            if (roomId) socket.emit('cursorUpdate', getCursorPosition());
        });

        function openFileModal(filename, originalname) {
            const ext = filename.split('.').pop().toLowerCase();
            const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'tiff', 'webp', 'svg', 'heif', 'heic', 'raw', 'psd', 'eps', 'ai', 'ico', 'avif', 'dng', 'cr2', 'nef', 'orf'];
            if (imageExtensions.includes(ext)) {
                modalContent.innerHTML = `<img src="https://air-exchange.onrender.com/uploads/${filename}" style="max-width: 100%; max-height: 80vh;">`;
            } else if (['mp4', 'webm', 'ogg'].includes(ext)) {
                modalContent.innerHTML = `<video controls style="max-width: 100%; max-height: 80vh;"><source src="https://air-exchange.onrender.com/uploads/${filename}" type="video/${ext}">Your browser does not support the video tag.</video>`;
            } else if (['xls', 'xlsx'].includes(ext)) {
                modalContent.innerHTML = `<p>Preview not available for ${originalname}. <a href="https://air-exchange.onrender.com/download/${filename}" download><i class="fas fa-download" style="color: white;"></i> Download instead</a>.</p>`;
            } else if (['doc', 'docx'].includes(ext)) {
                modalContent.innerHTML = `<p>Preview not available for ${originalname}. <a href="https://air-exchange.onrender.com/download/${filename}" download><i class="fas fa-download" style="color: white;"></i> Download instead</a>.</p>`;
            } else if (['pdf'].includes(ext)) {
                modalContent.innerHTML = `<p>Preview not available for ${originalname}. <a href="https://air-exchange.onrender.com/download/${filename}" download><i class="fas fa-download" style="color: white;"></i> Download instead</a>.</p>`;
            } else {
                modalContent.innerHTML = `<p>Preview not available for ${originalname}. <a href="https://air-exchange.onrender.com/download/${filename}" download><i class="fas fa-download" style="color: white;"></i> Download instead</a>.</p>`;
            }
            fileModal.style.display = 'flex';
        }

        function closeModal() {
            fileModal.style.display = 'none';
            modalContent.innerHTML = '';
        }

        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `airxchange-notification ${type === 'add' ? 'add' : 'remove'}`;
            notification.style.display = 'block';
            setTimeout(() => notification.style.display = 'none', 3000);
            if (window.innerWidth <= 768) {
                notification.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }
        }

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFileUpload(e.dataTransfer.files);
        });
        fileInput.addEventListener('change', (e) => handleFileUpload(e.target.files));
        
        textEditor.addEventListener('input', handleTextInput);
        function switchTab(tabName) {
            document.querySelectorAll('.airxchange-tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`airxchange-${tabName}Tab`).classList.add('active');
            document.querySelectorAll('.airxchange-tab').forEach(el => el.classList.remove('active'));
            document.querySelector(`.airxchange-tab[onclick*="${tabName}"]`).classList.add('active');
        }

        // Cleanup expired saved texts every minute
        setInterval(updateSavedTexts, 60000);
    </script>
</body>
</html>