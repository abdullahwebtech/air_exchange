<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirForShare</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --background-color: #f5f5f5;
            --text-color: #000;
            --primary-color: #007bff;
            --primary-dark-color: #030507;
            --border-color: #007bff;
            --file-item-bg: #fff;
            --file-item-shadow: rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --background-color: #121212;
            --text-color: #fff;
            --primary-color: #1e90ff;
            --primary-dark-color: #0077cc;
            --border-color: #1e90ff;
            --file-item-bg: #1e1e1e;
            --file-item-shadow: rgba(255,255,255,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            color: var(--text-color);
        }

        body {
            background-color: var(--background-color);
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: var(--background-color);
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            gap: 5px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: var(--primary-color);
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }

        .tab.active {
            background: var(--primary-dark-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .text-editor {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            resize: none;
            font-size: 16px;
            margin-bottom: 15px;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .file-upload-section {
            border: 2px dashed var(--border-color);
            padding: 25px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .file-list {
            list-style: none;
            padding: 0;
        }

        .file-item {
            padding: 10px;
            background: var(--file-item-bg);
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px var(--file-item-shadow);
            display: flex;
            align-items: center;
        }

        .file-preview {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 15px;
        }

        .file-icon {
            font-size: 24px;
            margin-right: 15px;
        }

        .file-info {
            flex: 1;
            overflow: hidden;
        }

        .file-link {
            color: var(--primary-color);
            text-decoration: none;
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: var(--primary-color);
            color: white;
            margin: 5px;
        }

        .file-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .file-actions .btn {
            background: #dc3545;
        }

        .file-actions .btn.download-all {
            background: #28a745;
        }

        .file-actions-icons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .file-action-btn {
            cursor: pointer;
            padding: 5px;
            transition: 0.2s;
        }

        .file-action-btn:hover {
            opacity: 0.8;
        }

        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; margin-bottom: 20px;">AirXchange üöÄ </h1>
        
        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('text')">üìù Text</div>
            <div class="tab" onclick="switchTab('file')">üìÅ Files</div>
        </div>

        <!-- Text Tab -->
        <div id="textTab" class="tab-content active">
            <textarea 
                class="text-editor" 
                placeholder="Start typing..."
                oninput="handleTextInput()"
            ></textarea>
            <div style="text-align: center">
                <button class="btn" onclick="saveText()"><i class="fas fa-save"></i> Save</button>
                <button class="btn" onclick="clearText()"><i class="fas fa-trash"></i> Clear</button>
                <button class="btn" onclick="copyText()"><i class="far fa-copy"></i> Copy</button>
            </div>
        </div>

        <!-- File Tab -->
        <div id="fileTab" class="tab-content">
            <div class="file-actions">
                <button class="btn download-all" onclick="downloadAllFiles()">
                    <i class="fas fa-download"></i> Download All
                </button>
                <button class="btn" onclick="deleteAllFiles()">
                    <i class="fas fa-trash"></i> Delete All
                </button>
            </div>
            <div class="file-upload-section" id="dropZone">
                <p>üìÇ Drag & drop files here</p>
                <input type="file" id="fileInput" hidden>
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-upload"></i> Choose File
                </button>
            </div>
            <ul class="file-list" id="fileList"></ul>
        </div>
    </div>

    <button class="theme-toggle" onclick="toggleTheme()">
        <i class="fas fa-moon"></i>
    </button>

    <script src="https://air-exchange.vercel.app/socket.io/socket.io.js"></script>
    <script>
        const socket = io('https://air-exchange.vercel.app');
        const textEditor = document.querySelector('.text-editor');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        let files = [];

        // Initialize real-time text
        socket.on('init', (data) => {
            textEditor.value = data.text;
            files = data.files;
            updateFileList(files);
        });

        // Real-time text updates
        socket.on('textUpdate', (text) => {
            textEditor.value = text;
        });

        // Real-time file updates
        socket.on('newFile', (file) => {
            files.push(file);
            updateFileList(files);
        });

        // Handle file deletions
        socket.on('fileDeleted', (filename) => {
            files = files.filter(file => file.filename !== filename);
            updateFileList(files);
        });

        // Handle all files deletion
        socket.on('allFilesDeleted', () => {
            files = [];
            updateFileList(files);
        });

        // Text handling
        function handleTextInput() {
            socket.emit('textUpdate', textEditor.value);
        }

        function saveText() {
            const blob = new Blob([textEditor.value], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `airforshare-${Date.now()}.txt`;
            a.click();
        }

        function clearText() {
            if(confirm('Clear all text?')) textEditor.value = '';
        }

        // File handling
        function updateFileList(files) {
            fileList.innerHTML = files.map(file => {
                const isImage = file.originalname.match(/\.(jpg|jpeg|png|gif)$/i);
                const preview = isImage ? 
                    `<img src="https://air-exchange.vercel.app/uploads/${file.filename}" class="file-preview">` : 
                    `<div class="file-icon">üìÑ</div>`;

                return `
                    <li class="file-item">
                        ${preview}
                        <div class="file-info">
                            <a href="https://air-exchange.vercel.app/uploads/${file.filename}" 
                               class="file-link" 
                               download="${file.originalname}">
                                ${file.originalname}
                            </a>
                            <small>${new Date(file.timestamp).toLocaleTimeString()}</small>
                        </div>
                        <div class="file-actions-icons">
                            <a href="https://air-exchange.vercel.app/uploads/${file.filename}" download 
                               class="file-action-btn" title="Download">
                                ‚¨áÔ∏è
                            </a>
                            <span class="file-action-btn" title="Delete" 
                                  onclick="deleteSingleFile('${file.filename}')">
                                üóëÔ∏è
                            </span>
                        </div>
                    </li>
                `;
            }).join('');
        }

        // Handle file upload
        function handleFileUpload(file) {
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (!data.success) throw new Error('Upload failed');
            })
            .catch(err => {
                alert('File upload failed!');
                console.error('Upload error:', err);
            });
        }

        // Delete All Files
        async function deleteAllFiles() {
            if(!confirm('Delete ALL files permanently?')) return;
            
            try {
                const response = await fetch('/delete-all', { method: 'DELETE' });
                const data = await response.json();
                if(data.success) {
                    files = [];
                    updateFileList(files);
                }
            } catch(err) {
                alert('Failed to delete files');
            }
        }

        // Download All Files
        async function downloadAllFiles() {
            if(files.length === 0) return alert('No files to download!');
            
            const zip = new JSZip();
            const folder = zip.folder("AirForShare_Files");
            
            // Add files to zip
            for(const file of files) {
                const response = await fetch(`/uploads/${file.filename}`);
                const blob = await response.blob();
                folder.file(file.originalname, blob);
            }

            // Generate and download zip
            zip.generateAsync({type:"blob"}).then(content => {
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = `AirForShare_Files_${Date.now()}.zip`;
                a.click();
            });
        }

        // Delete Single File
        async function deleteSingleFile(filename) {
            if(!confirm('Delete this file permanently?')) return;
            
            try {
                const response = await fetch(`/delete-file/${filename}`, { 
                    method: 'DELETE' 
                });
                const data = await response.json();
                if(data.success) {
                    files = files.filter(f => f.filename !== filename);
                    updateFileList(files);
                }
            } catch(err) {
                alert('Failed to delete file');
            }
        }

        // Drag & drop
        document.getElementById('dropZone').addEventListener('dragover', (e) => e.preventDefault());
        document.getElementById('dropZone').addEventListener('drop', (e) => {
            e.preventDefault();
            handleFileUpload(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0]));

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            // Show the selected tab content
            document.getElementById(`${tabName}Tab`).classList.add('active');

            // Update tab buttons
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');
        }

        // Theme toggle
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const themeToggle = document.querySelector('.theme-toggle');
            if (theme === 'dark') {
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
    </script>
</body>
</html>